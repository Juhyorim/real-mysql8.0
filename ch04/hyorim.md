ch04 아키텍처
-

- MySQL 서버 = MySQL 엔진 + 스토리지 엔진
  - 스토리지 엔진을 구현해서 MySQL 서버에 추가가능
  - InnoDB, MyISAM이 있다

---

### 4.1 MySQL 엔진 아키텍처
- MySQL 엔진의 구조는 독특하다
  - 프로그래밍 API
  - 커넥션 핸들러, SQL 인터페이스, SQL 파서, SQL옵티마이저, 캐시 및 버퍼
  - 스토리지 엔진 API
  - 디스크(데이터 파일, 로그파일)

### 4.1.1.1 MySQL 엔진
- 커넥션 핸들러: 클라이언트의 접속 및 쿼리 요청 처리
- SQL 파서, 전처리기
- 옵티마이저: 쿼리 최적화 시행 위함

### 4.1.1.2 스토리지 엔진
- 스토리지 엔진은 실제 데이터를 디스크 스토리지에 저장하거나 디스크 스토리지로부터 데이터 읽어오는 부분
- 스토리지 엔진은 여러 개 동시 사용 가능
- 지정한 테이블의 모든 읽기/변경/삭제 작업을 처리

### 4.1.1.3 핸들러 API
- MySQL 엔진이 쿼리 실행기에서 데이터 읽쓰할 때 스토리지 엔진에 요처앟ㅁ
  - 핸들러 요청, 핸들러 API 사용

### 4.1.2 MySQL 스레딩 구조
- 구조
  - 포그라운드 스레드, 백그라운드 스레드
  - 캐시 & 버퍼, 로그버퍼
  - 디스크
- MySQL 서버는 프로세스 기반이 아니라 스레드 기반 작동
  - 포그라운드 스레드, 백그라운드 스레드
- 스레드 모델 -> MySQL 커뮤니티 에디션에서 사용함
  - 엔터프라이즈는 스레드 풀 모델 사용함
  - 커넥션 별로 여러 개의 커넥션 요청 -> 스레드 풀 모델
  - 커넥션 별로 포그라운드 스레디 하나씩 생성 및 할당

### 4.1.2.1 포그라운드 스레드
- 각 클라이언트 사용자가 요청하는 쿼리 문장 처리
- 클라이언트 사용자가 작업을 마치고 커넥션을 종료하면 해당 커넥션 담당하던 스레드가 다시 스레드 캐시로 돌아감
- 데이터를 MySQL의 데이터 버퍼나 캐시로부터 가져옴
  - 없으면 직접 디스크의 데이터나 인덱스 파일로부터 데이터 읽어옴
- Inno 테이블은 데이터 버퍼나 캐시까지만 포그라운드 스레득 처리, 나머지 버퍼로부터 디스크까지 기록 작업은 백그라운드 스레드가 처리

### 4.1.2.2 백그라운드 스레드
- 인서트 버퍼를 병합
- 로그를 디스크로 기록
- InnoDB 버퍼풀의 데이터를 디스크에 기록
- 데이터를 버퍼로부터 읽어옴
- 잠금이나 데드락을 모니터링

### 4.1.3 메모리 할당 및 사용구조
- 글로벌 메모리 영역과 로컬 메모리 영역이 있다
- 글로벌 메모리 영역 
  - 하나의 메모리 공간만 할당
  - 테이블 캐시
  - InnoDB 버퍼 풀
  - InnoDB 어댑티브 해시 인덱스
  - InnoDB 리두 로그 버퍼
- 로컬 메모리 영역
  - 클라이언트 스레드가 쿼리 처리할 때 사용(독립 할당)
  - 정렬버퍼
  - 조인 버퍼
  - 바이너리 로그 캐시
  - 네트워크 버퍼

### 4.1.4 플러그인 스토리지 모델
- MySQL의 독특한 구조, 플러그인 모델!
- 스토리지 엔진, 검색어 파서, 사용자 인증 Native Authentication 등등 모두 플러그인
- MySQL 쿼리 실행과정 -> MySQL 엔진에서 대부분, 스토리지 엔진에서 읽/쓰 작업
  - GROUP BY나 ORDER BY와 같은 복잡한 처리는 MySQL 엔진의 쿼리 실행기에서 처리


### 4.1.5 컴포넌트
- MySQL 8.0부터 기존 플러그인 아키텍처 대체위해 컴포넌트 아키텍처 지원됨
- 플러그인 모델 단점
  - 플러그인은 오직 MySQL 서버와 인터페이스 가능, 플러그인끼리는 불가능
  - MySQL 서버의 변수나 함수를 직접 호출 -> 안전하지 않음
  - 상호 의존관계를 설정할 수 없어서 초기화가 어려움


### 4.1.6 쿼리 실행 구조
- 쿼리파서 -> 전처리기 -> 옵티마이저 -> 쿼리실행기 -> 스토리지엔진 -> SQL결과 출력
- 쿼리파서: 요청 쿼리문장을 토큰으로 분리해 트리형태의 구조로 만들어냄
- 전처리기: 파서 트리 기반, 쿼리 문장에 구조적 문제점 확인
- 옵티마이저: 쿼리 문장은 저렴한 비용으로 가장 빠르게 처리할 지 결정
- 실행엔진: 
  - 실행 엔진은 핸들러에게 임시테이블 만들라고 요청
  - 실행 엔진은 WHERE절에 일치하는 레코드 읽을 거를 핸들러에게 요청
  - 읽어온 레코드들을 1번에 저장하라고 핸들러 요청
  - 임시테이블에서 필요한 방식으로 데이터 읽어오라고 요청
  - 최종적으로 결과를 사용자나 다른 모듈로 넘김

### 4.1.6.8 쿼리 캐시 - 사라짐
- 8.0에서 제거됨

### 4.1.9 스레드 풀
- 엔터프라이즈 버전에서 제공됨
  - 엔터프라이즈: 서버 프로그램에 내장
  - Percona Server: 플러그인 형태로 작동
- 내부적으로 사용자의 요청을 처리하는 스레드 개수를 줄여 동시 처리되는 요청이 많아도 MySQL 서버의 CPU가 제한된 개수의 스레드 처리에만 집중할 수 있게 함 -> 서버의 자원 소모를 줄이는 목적
- 제한된 수의 스레드로 CPU가 처리하도록 적절히 유도하면 프로세서 친화도를 높이고 OS입장 불필요 컨텍스트 스위치를 줄여 오버헤드 줄어듦

### 4.1.10 트랜잭션 지원 메타데이터
- db서버에서 테이블 구조 정보와 스토어드 프로그램 등의 정보를 데이터 딕셔너리, 메타데이터라고 함
  - 8.0버전부터 테이블의 구조 정보와 스토어드 프로그램 코드 관련 정보를 InnoDB테이블에 저장하도록 개선됨
  - 시스템 테이블, 데이터 딕셔너리 정보 모두 mySQL DB에 저장하고 있다
- 트랜잭션 기반의 InnoDB 스토리지 엔진에 저장되도록 개선되면서 -> 스키마 변경 작업 중간에 MySQL 서버가 비정상적으로 종료되더라도 스키마 변경 일관적
- MyISAM이나 CSV 스토리지 엔진은 SDI 파일 사용함


---

4.2 InnoDB 스토리지 엔진 아키텍처
-

- MySQL의 스토리지 엔진 가운데 가장 많이 사용
- InnoDB는 MySQL에서 사용할 수 있는 스토리지 엔진 중 거의 유일하게 레코드 기반의 잠금 제공
  - 높은 동시성 처리, 안정성, 성능뛰어남

---

### 4.2.1 프라이머리 키에 의한 클러스터링

- InnoDB의 모든 테이블은 기본적으로 PK를 기준, 클러스터링 되어 저장됨
- 프라이머리 키 값의 순서대로 디스크에 저장
- 모든 세컨더리 인덱스는 레코드의 주소 대신 프라이머리 키의 값을 논리적인 주소로 사용함
  - 프라이머리 키가 클러스터링 인덱스 -> PK이용한 range 스캔 상당히 빠름
  - 쿼리 실행계획에서 PK는 기본적으로 다른 보조 인덱스 비해 비중 높게 설정됨
- MyISAM에서는 클러스터링 키를 지원 x
  - pk는 유니크 제약을 가진 세컨더리 인덱스일 뿐
  - 모든 인덱스는 물리적인 레코드의 주소값을 가진다


### 4.2.2 외래키 지원
- InnoDB 스토리지 엔진 레벨에서 지원하는 기능
- 디비 서버 운영의 불편함 때문에 서비스용 데이터베이스에서는 생성하지 않는 경우도 자주 있음
- InnoDB에서 외래키는 부모 테이블과 자식 테이블 모두 해당 칼럼에 인덱스 생성 필요, 변경 시 반드시 부모 테이블이나 자식 테이블에 데이터가 있는지 체크하는 작업이 필요함
  - 잠금이 여러 테이블로 전파 -> 데드락 발생 주의
- 시스템 변수 조정하면 외래 키 관계에 대한 체크 작업이 일시적으로 멈출 수 있다
  - 일관성 조정을 필수임


### 4.2.3 MVCC(Multi Verson Consurrency Control)
- 일반적으로 레코드 레벨의 tx를 지원하는 DBMS가 제공하는 기능이다
- 잠금을 사용하지 않는 일관된 읽기를 제공함
- InnoDB는 언두로그를 이용해 기능을 구현
- 


### 4.2.4 잠금 없는 일관된 읽기(Non-Locking Consistent Read)


### 4.2.13 InnoDB와 MyISAM, MOMORY 스토리지 엔진 비교
- MySQL 8.0부터 MySQL 서버의 모든 시스템 테이블이 InnoDB 스토리지 엔진으로 교체됨
- MyISAM 스토리지 엔진 기능 도태되는중
- MEMORY 스토리지 엔진도 동시 처리 성능에 있어 Inno 못따라감
  - 모든 처리를 메모리에서만 수행하니 빠를 수 있지만
  - MySQL 서버는 일반적으로 온라인 tx 처리를 위한 목적으로 사용, 동시처리 성능이 매우 중요하다
  - 가변 길이 타입 컬럼을 지원하지 않는 문제점 -> 내부 임시 테이블로 TempTable 스토리지 엔진치 대체함

















































